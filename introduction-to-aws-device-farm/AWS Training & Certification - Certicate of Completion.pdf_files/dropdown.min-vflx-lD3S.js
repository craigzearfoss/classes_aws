define(["require","exports","tslib","classnames","react","spectrum/button","spectrum/colorized_icon","spectrum/icon_action","spectrum/icon_content","spectrum/icon_global","spectrum/toggle","modules/clean/browse_interface","modules/clean/em_string","modules/clean/filename_highlights","modules/clean/filepath","modules/clean/paper_formatting_utils","modules/clean/react/browse/models","modules/clean/react/files_view/star","modules/clean/react/icon/file_folder_icon","modules/clean/react/title_bubble","modules/clean/search/constants","modules/clean/search/logger","modules/clean/search/models","modules/clean/search/search_bar/chips","modules/clean/search/search_bar/preview","modules/clean/search/search_bar/query_suggestions_table","modules/clean/search/types","modules/clean/search/search_helpers","modules/clean/react/retrieval_success_banner/util","modules/core/browser","modules/core/i18n","modules/core/accessible_announce","spectrum/file_icon"],(function(e,t,r,o,n,a,s,i,l,c,u,h,p,d,_,m,f,g,w,b,y,C,E,S,v,D,M,H,x,R,O,k,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=r.__importDefault(o),n=r.__importDefault(n),d=r.__importStar(d),_=r.__importStar(_),m=r.__importStar(m),C=r.__importStar(C),S=r.__importStar(S),H=r.__importStar(H),R=r.__importStar(R);var I=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._announceLoading=function(){k.AccessibleAnnounce.polite(O._("Loading search…"))},t._ignoreMouseDown=function(e){e.stopPropagation(),e.preventDefault()},t._onClearAllHistoryMouseDown=function(e){e.stopPropagation(),e.preventDefault(),t.props.onHistoryClearAllClick&&H.shouldHandleClick(e)&&t.props.onHistoryClearAllClick()},t._renderHistoryHeader=function(){var e=O._("RECENT SEARCHES"),r=O._("CLEAR ALL");return n.default.createElement(z,{className:"search-bar__history-header search-bar__dropdown-item--border-top",id:"search-dropdown-history-header",onMouseDown:t._ignoreMouseDown,"aria-label":e,"aria-selected":!1},n.default.createElement("div",null,e),n.default.createElement(a.Button,{tagName:"a",variant:"styleless",onClick:t._onClearAllHistoryMouseDown},r))},t}return r.__extends(t,e),t.prototype.componentDidMount=function(){this.props.searchBarLoading&&this._announceLoading(),this._shouldShowRecentHistory(this.props)&&C.logRecentHistoryDisplayed({searchSessionId:this.props.searchSessionId,user:this.props.user,history:this.props.searchHistory})},t.prototype.componentWillReceiveProps=function(e){this._willShowRecentHistoryOnPropsChange(e)&&C.logRecentHistoryDisplayed({searchSessionId:e.searchSessionId,user:e.user,history:e.searchHistory})},t.prototype.componentDidUpdate=function(e){var t=this.props,r=t.searchBarLoading,o=t.normalizedQuery,n=t.searchResults,a=t.onDropdownTTI;r&&!e.searchBarLoading&&this._announceLoading(),o&&e.searchBarLoading&&!r&&(k.AccessibleAnnounce.polite(O.ungettext("Found %(num)s search result","Found %(num)s search results",n.length).format({num:n.length})),a&&a())},t.prototype._shouldShowRecentHistory=function(e){return e.isOpen&&!e.normalizedQuery&&e.searchHistory.length>0},t.prototype._shouldShowPosteriorQuerySuggestions=function(e){var t=e.isOpen,r=e.normalizedQuery,o=e.areQuerySuggestionsLoaded;return t&&!!r&&!!o},t.prototype._willShowRecentHistoryOnPropsChange=function(e){return this._shouldShowRecentHistory(e)&&(this.props.normalizedQuery!==e.normalizedQuery||0===this.props.searchHistory.length&&e.searchHistory.length>0||!this.props.isOpen&&e.isOpen)},t.prototype._renderPosteriorQuerySuggestions=function(){var e=this.props,t=e.querySuggestions,r=e.onQuerySuggestionsClick,o=e.highlightedRow,a=e.onHighlightDropdownItem;if(t&&r){return n.default.createElement(D.QuerySuggestionsTable,{querySuggestions:t,onQuerySuggestionsClick:r,indexOffset:1,highlightedRow:o,onHighlightDropdownItem:a})}return null},t.prototype.renderScopeChipDropdown=function(e){var t=this.props,r=t.searchBarExperiments,o=t.highlightedRow,a=t.onHighlightDropdownItem,s=t.browseScope,i=t.scopeChip,l=t.onSearchChipInteraction,c=_.child_dir(s),u=p.Emstring.em_snippet(c,16,.6),h=O.intl.formatMessage(O._("Filter to <strong>%(folder_name)s</strong>"),{folder_name:u,strong:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("strong",{key:"title"},e)}}),d=n.default.createElement("span",null,h),m=u!==c;return n.default.createElement(T,{row:e,searchBarExperiments:r,highlightedRow:o,onHighlightDropdownItem:a,isOn:S.isValidPathForChip(i),text:d,tooltip:m?c:void 0,onInteraction:l,className:"search-bar__dropdown_chip-toggle--scope"})},t.prototype.render=function(){var e,t=[],a=this._shouldShowRecentHistory(this.props),s=this.props.dropdownHeaderItems,i=s.length,l=M.SearchBarDropdownHeaderItemType.SEARCH_ALL,c=this.props.showLinkToResultsPage&&!a&&-1!==s.indexOf(l),u=M.SearchBarDropdownHeaderItemType.SCOPE_CHIPS,h=this.props.scopeChip&&-1!==s.indexOf(u),p=this.props,d={highlightedRow:p.highlightedRow,onHighlightDropdownItem:p.onHighlightDropdownItem,searchPath:p.searchPath,searchSessionId:p.searchSessionId,user:p.user};if(a)for(var _=0;_<this.props.searchHistory.length;_++){var m=this.props.searchHistory[_];t.push(n.default.createElement(F,r.__assign({},d,{indexOffset:i,key:m.rawQuery,onClick:this.props.onHistoryItemClick,onContextMenuCapture:this.props.onRecentSearchContextMenuCapture,query:m,row:_+i})))}else{var g=Math.min(y.MaxResults.MAX_SEARCH_SUGGESTIONS,this.props.searchResults.length);for(_=0;_<g;_++){var w=this.props.searchResults[_],b=r.__assign(r.__assign({},this.props),{row:_+i,indexOffset:i,resultCount:g});w instanceof E.SlimFileSearchResult||w instanceof f.File?t.push(n.default.createElement(q,r.__assign({},b,{resultObject:w,key:w.fq_path}))):w instanceof f.Paper?t.push(n.default.createElement(B,r.__assign({},b,{resultObject:w,key:w.pad_id}))):w instanceof f.PaperFolder?t.push(n.default.createElement(L,r.__assign({},b,{resultObject:w,key:w.folder_id}))):w instanceof f.FileSharedWithMe&&t.push(n.default.createElement(Q,r.__assign({},b,{resultObject:w,key:w.file_id})))}}var C,S=((e={"search-bar__dropdown":!0,"is-expanded":this.props.isOpen})[this.props.className||""]=!0,e);C="function"==typeof this.props.children?this.props.children():n.default.createElement("noscript",null);var v=this._shouldShowPosteriorQuerySuggestions(this.props);return n.default.createElement("div",{className:o.default(S),"aria-hidden":!this.props.isOpen},n.default.createElement("ol",{className:o.default({"search-bar__dropdown-items":!0}),id:"search-bar__dropdown-items",role:"listbox","aria-label":O._("search dropdown")},c&&n.default.createElement(N,r.__assign({},this.props)),h&&this.renderScopeChipDropdown(s.indexOf(u)),v&&this._renderPosteriorQuerySuggestions(),a&&this._renderHistoryHeader(),t,C),this.props.searchBarLoading&&n.default.createElement("div",{className:"search-bar__loading"},n.default.createElement("span",{className:"ax-visually-hidden"},O._("Loading search..."))))},t.defaultProps={showLinkToResultsPage:!0},t})(n.default.Component);t.SearchBarDropdown=I;var T=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._onMouseEnter=function(){return t.props.onHighlightDropdownItem(t.props.row)},t._onMouseDown=function(e){e.stopPropagation(),e.preventDefault(),H.shouldHandleClick(e)&&t.props.onInteraction&&t.props.onInteraction(!t.props.isOn)},t._onToggleClick=function(e){e.stopPropagation(),e.preventDefault()},t}return r.__extends(t,e),t.prototype.render=function(){var e=this.props,t=e.row,r=e.highlightedRow,a=e.isOn,l=e.text,c=e.tooltip,h=e.className,p=this.props.row===r,d={"search-bar__dropdown-item":!0,"search-bar__dropdown-item--border-top":!0,"search-bar__full_search_suggestion":!0,"search-bar__dropdown_chip-toggle":!0,"search-bar__dropdown-item--is-highlighted":p};h&&(d[h]=!0);var _=a?O._("On"):O._("Off"),m=O._("%(header_text)s: %(toggle_description)s",{comment:"format string for aria label for the search bar chip toggle"}).format({header_text:l,toggle_description:_});return n.default.createElement(z,{id:"search-dropdown-item"+t,className:o.default(d),onMouseEnter:this._onMouseEnter,onMouseDown:this._onMouseDown,"aria-selected":p,"aria-label":m},n.default.createElement("div",{className:"mc-media-cell-icon search-bar__dropdown-item-cell-icon"},n.default.createElement(s.ColorizedIcon,{color:"#6A7C8F"},n.default.createElement(i.IconAction,{name:"sort",className:"search-bar__chip-icon--sort"}))),n.default.createElement("div",{className:"search-bar__header-text"},c?n.default.createElement(b.TitleBubble,{content:c,position:b.TitleBubble.POSITIONS.BOTTOM},l):l),n.default.createElement("div",{className:"search-bar__chip_toggle"},n.default.createElement(u.Toggle,{onClick:this._onToggleClick,interactive:!1,labelContent:_,ariaLabel:_,checked:a})))},t})(n.default.Component),N=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._renderTitle=function(){var e=t.props.searchPath;return _.paths_are_equal(e,"/")?O.intl.formatMessage(O._("View all results for “%(query)s”"),{query:t.props.normalizedQuery,strong:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("strong",{key:"title"},e)}}):O.intl.formatMessage(O._("View all results for <span>“%(query)s”</span> in <strong>%(current_path)s</strong>"),{current_path:_.filename(e),query:t.props.normalizedQuery,span:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("span",{key:"title"},e)},strong:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("strong",{key:"path"},e)}})},t._renderTitleText=function(){var e=t.props.searchPath;return _.paths_are_equal(e,"/")?O._("View all results for “%(query)s”").format({query:t.props.normalizedQuery}):O._("View all results for “%(query)s” in %(current_path)s").format({query:t.props.normalizedQuery,current_path:_.filename(e)})},t._onMouseDown=function(e){e.stopPropagation(),e.preventDefault(),H.shouldHandleClick(e)&&t.props.onSearch(t.props.normalizedQuery)},t._onMouseEnter=function(){return t.props.onHighlightDropdownItem(0)},t}return r.__extends(t,e),t.prototype.render=function(){var e=0===this.props.highlightedRow,t={"search-bar__dropdown-item":!0,"search-bar__dropdown-item--border-top":!0,"search-bar__dropdown-item--header":!0,"search-bar__dropdown-item--is-highlighted":e,"search-bar__full_search_suggestion":!0,"js-search-bar__view-all-results":!0};return n.default.createElement(z,{className:o.default(t),id:"search-dropdown-item0",onMouseDown:this._onMouseDown,onMouseEnter:this._onMouseEnter,"aria-selected":e,"aria-label":this._renderTitleText()},n.default.createElement("div",{className:"mc-media-cell-icon search-bar__dropdown-item-cell-icon"},n.default.createElement(s.ColorizedIcon,{color:"#6A7C8F"},n.default.createElement(c.IconGlobal,{name:"search-small",className:"search-bar__dropdown-item-icon--search"}))),n.default.createElement("div",{className:"search-bar__header-text"},this._renderTitle()))},t})(n.default.Component),B=(function(e){function t(t){var r=e.call(this,t)||this;return r.state=r._calcState(t),r}return r.__extends(t,e),t.prototype._calcState=function(e){return{titleParts:m.getPaperDocTitleParts(e.resultObject,"search-bar__dropdown-item-icon","search-bar__dropdown-item-icon-emoji")}},t.prototype.componentWillReceiveProps=function(e){if(this.props.resultObject.title!==e.resultObject.title){var t=this._calcState(e);this.setState(t)}},t.prototype.render=function(){var e=this.state.titleParts,t=e.highlightedTitle,o=e.title,a=e.icon;return n.default.createElement(A,r.__assign({},this.props,{icon:a,title:t,ariaTitle:o,location:"Paper"}))},t})(n.default.Component),L=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.render=function(){var e=this.props.resultObject,t=n.default.createElement(l.IconContent,{name:"folder-small",className:"search-bar__dropdown-item-icon"}),o=e.highlight_spans&&e.highlight_spans.length>0?d.highlightReactFromHighlightSpans(e.name,e.highlight_spans):n.default.createElement("span",null,e.name);return n.default.createElement(A,r.__assign({},this.props,{icon:t,title:o,ariaTitle:e.name,location:"Paper"}))},t})(n.default.Component),Q=function(e){var t=e.resultObject,o=n.default.createElement(P.FileIcon,{path:t.filename}),a=t.highlight_spans&&t.highlight_spans.length>0?d.highlightReactFromHighlightSpans(t.filename,t.highlight_spans):n.default.createElement("span",null,t.filename);return n.default.createElement(A,r.__assign({},e,{icon:o,title:a,ariaTitle:t.filename,location:O._("Shared with you")}))},q=(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.render=function(){var e=this.props.resultObject,t=_.filename(e.fq_path),o=_.parent_dir(e.fq_path),a="Dropbox",s=o.split("/");s.shift(),e.is_unmounted&&s.length>0&&(a=s.shift());var i=s[s.length-1];s.length>=2&&(a+="/..."),i&&i.length&&(a+="/"+i);var l,c=r.__assign({isDeleted:e.is_unmounted},e);return l=e.highlight_spans?d.highlightReactFromHighlightSpans(t,e.highlight_spans):d.highlightMatchReact(t,e.filename_highlights),n.default.createElement(A,r.__assign({},this.props,{icon:n.default.createElement(w.FileOrFolderIcon,{className:"search-bar__dropdown-item-icon",file:c}),title:l,ariaTitle:t,location:a,isUnmounted:e.is_unmounted,parentFolderUrl:h.browse_uri_for_fq_path(this.props.user,o).toString()}))},t})(n.default.Component);function F(e){var t=e.query,o=e.searchPath,a=e.searchSessionId,i=e.user,l=O._("Search for %(query)s").format({query:t.rawQuery}),u=n.default.createElement("div",{className:"mc-media-cell-icon search-bar__dropdown-item-cell-icon"},n.default.createElement(s.ColorizedIcon,{color:"#6A7C8F"},n.default.createElement(c.IconGlobal,{name:"search-small",className:"search-bar__recent_search-icon--search"}))),h=H.buildSearchURL({user:i,searchPath:o,normalizedQuery:t.normalizedQuery,searchSessionId:a,searchToken:H.getSearchCsrfToken()}).toString(),p=j;return n.default.createElement(p,r.__assign({},e,{data:t,titleText:t.rawQuery,ariaLabel:l,classes:{"search-bar__recent_search":!0},icon:u,href:h,noTopBorder:!0}))}var j=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._onMouseDown=function(e){e.stopPropagation(),e.preventDefault(),t.props.onClick&&H.shouldHandleClick(e)&&t.props.onClick(t.props.data,t.props.row)},t._onContextMenuCapture=function(){t.props.onContextMenuCapture&&t.props.onContextMenuCapture(t.props.data,t.props.row)},t._onMouseEnter=function(){return t.props.onHighlightDropdownItem(t.props.row)},t}return r.__extends(t,e),t._onClick=function(e){H.shouldHandleClick(e)&&(e.stopPropagation(),e.preventDefault())},t.prototype.render=function(){var e=this.props,a=e.ariaLabel,s=e.highlightRanges,i=e.highlightedRow,l=e.href,c=e.icon,u=e.indexOffset,h=e.noTopBorder,p=e.row,_=e.titleText,m=p===i,f=d.highlightReactFromHighlightSpans(_,s),g=p-u,w=r.__assign(r.__assign({},this.props.classes),{"search-bar__dropdown-item--is-highlighted":m,"search-bar__dropdown-item--border-top":!h&&0===g});return n.default.createElement(z,{className:o.default(w),id:"search-dropdown-item"+p,onMouseDown:this._onMouseDown,onMouseEnter:this._onMouseEnter,onClick:t._onClick,"aria-selected":m,"aria-label":a},c,n.default.createElement("a",{href:l,onContextMenuCapture:this._onContextMenuCapture},n.default.createElement("div",{className:"search-bar__row-name"},f)))},t.defaultProps={noTopBorder:!1},t})(n.default.Component),A=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._onMouseDown=function(e){e.stopPropagation(),e.preventDefault(),H.shouldHandleClick(e)&&t.props.onSearchResultOpen(t.props.resultObject)},t._onPathLinkClick=function(e){var r=t.props.searchBarExperiments;e.stopPropagation(),e.preventDefault(),r.expSearchSuccessBanner&&"/h"===R.get_pathname()&&x.setSearchSuccessBannerVisibleFromHome(),H.shouldHandleClick(e)&&t.props.onResultObjectPathClick(t.props.resultObject)},t._onMouseEnter=function(){return t.props.onHighlightDropdownItem(t.props.row)},t._onContextMenuCapture=function(){var e=t.props,r=e.onContextMenuCapture,o=e.resultObject;r&&r(o)},t._getSearchBarDropdownResultVariant=function(){var e,r=t.props,o=r.isUnmounted,a=r.location,s=r.resultObject,i=r.user,l=r.title,c=r.parentFolderUrl;e=o?O.intl.formatMessage(O._("not added yet, in <locationSpan>%(location)s</locationSpan>",{comment:"Describes the mountable directory of a file in a list of search results."}),{location:a,locationSpan:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("span",{key:"location",title:a},e)}}):O.intl.formatMessage(O._("<locationSpan>in %(location)s</locationSpan>",{comment:"Describes the parent directory of a file in a list of search results."}),{location:a,locationSpan:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("span",{key:"location",title:a},e)}});var u=H.resultObjectToUrl(s,i),h=n.default.createElement(g.StarContainer,{item:s,user:i,key:"dropdownStar",className:"search-bar__search-result-star",isReadOnly:!0});return n.default.createElement("div",null,n.default.createElement(v.SearchBarDropdownPreview,{result:s,visible:t.props.row===t.props.highlightedRow,user:i,searchSessionId:t.props.searchSessionId,position:t.ref?window.innerHeight-t.ref.getBoundingClientRect().bottom:void 0}),n.default.createElement("a",{href:u,onContextMenuCapture:t._onContextMenuCapture},n.default.createElement("div",{className:"search-bar__search-result-name-star-group"},n.default.createElement("div",{className:"search-bar__search-result-name"},l),h)),n.default.createElement("div",{className:"search-bar__search-result-desc"},c?n.default.createElement("a",{href:c,onMouseDown:t._onPathLinkClick,onContextMenuCapture:t._onContextMenuCapture,className:"search-bar__search-result-desc-link"},e):n.default.createElement("span",null,e)))},t.setRef=function(e){t.ref=e},t}return r.__extends(t,e),t.prototype.render=function(){var e=this.props,t=e.highlightedRow,r=e.indexOffset,a=e.row,s=e.resultCount,i=e.icon,l=e.ariaTitle,c=e.location,u=a===t,h=a-r,p={"search-bar__dropdown-item":!0,"search-bar__result":!0,"search-bar__dropdown-item--is-highlighted":u,"search-bar__dropdown-item--border-top":0===h},d=O._("Search Result %(index)s of %(result)s: %(aria_title)s in %(location)s").format({index:h+1,result:s,aria_title:l,location:c});return n.default.createElement(z,{className:o.default(p),id:"search-dropdown-item"+a,onMouseDown:this._onMouseDown,onMouseEnter:this._onMouseEnter,"aria-selected":u,_ref:this.setRef,"aria-label":d},n.default.createElement("div",{className:"mc-media-cell-icon search-bar__dropdown-item-cell-icon"},i),this._getSearchBarDropdownResultVariant())},t})(n.default.Component),z=function(e){var t=e._ref,o=r.__rest(e,["_ref"]);return n.default.createElement("li",r.__assign({role:"option","aria-label":e["aria-label"],"aria-selected":e["aria-selected"],tabIndex:0,ref:t},o))}}));
//# sourceMappingURL=dropdown.min.js-vflv-2p7g.map